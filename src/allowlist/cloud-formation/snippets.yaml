---
Outputs:
  ApiEndpoint:
    Description: 'Public API endpoint URL'
    Value: !Join
    - ''
    - - 'https://'
      - !Ref 'RestApi'
      - '.execute-api.'
      - !Ref 'AWS::Region'
      - '.amazonaws.com/'
      - !Ref 'AWS::StackName'
Resources:
  # Application load balancer, connected directly to container runner.
  Alb:
    Properties:
      Scheme: 'internal'
      SecurityGroups:
      - !Ref 'AlbSecurityGroup'
      Subnets:
      - !Ref 'SubnetA'
      - !Ref 'SubnetB'
      Type: 'application'
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
  # Application load balancer listener.
  AlbListener:
    Properties:
      DefaultActions:
      - TargetGroupArn: !Ref 'ContainerTargetGroup'
        Type: 'forward'
      LoadBalancerArn: !Ref 'Alb'
      Port: !Ref 'AlbListenerPort'
      Protocol: 'HTTP'
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
  # Application load balancer as a target group.
  AlbTargetGroup:
    Properties:
      HealthCheckPath: !Ref 'ContainerHealthCheckPath'
      Port: !Ref 'ContainerPort'
      Protocol: 'HTTP'
      TargetType: 'alb'
      VpcId: !Ref 'VPC'
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
  # ECS service for running the allowlist server container.
  ContainerRunner:
    Properties:
      Cluster: !Ref 'ContainerCluster'
      LaunchType: 'FARGATE'
      LoadBalancers:
      - ContainerName: !Ref 'ContainerName'
        ContainerPort: !Ref 'ContainerPort'
        TargetGroupArn: !Ref 'ContainerTargetGroup'
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: 'ENABLED'
          SecurityGroups:
          - !Ref 'ContainerSecurityGroup'
          Subnets:
          - !Ref 'SubnetA'
          - !Ref 'SubnetB'
      TaskDefinition: !Ref 'ContainerDefinition'
    Type: 'AWS::ECS::Service'
  # Network load balancer listener.
  NlbListener:
    Properties:
      DefaultActions:
      - TargetGroupArn: !Ref 'AlbTargetGroup'
        Type: 'forward'
      LoadBalancerArn: !Ref 'Nlb'
      Port: !Ref 'AlbListenerPort'
      Protocol: 'TCP'
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
  # Public REST API gateway.
  RestApi:
    Properties:
      EndpointConfiguration:
        Types:
        - 'EDGE'
      Name: !Ref 'AWS::StackName'
    Type: 'AWS::ApiGateway::RestApi'
  # Deployment of Rest API gateway.
  RestApiDeployment:
    DependsOn:
    - 'RestApiGet'
    - 'RestApiPost'
    # Use a nonce to force a new deployment when the API configuration changes.
    Metadata:
      Nonce: 5
    Properties:
      RestApiId: !Ref 'RestApi'
      StageName: !Ref 'AWS::StackName'
    Type: 'AWS::ApiGateway::Deployment'
  # GET method for the REST API, forwarding requests to the load balancer.
  RestApiGet:
    DependsOn:
    - 'LoadBalancerListener'
    Properties:
      ApiKeyRequired: false
      AuthorizationType: 'NONE'
      HttpMethod: 'GET'
      Integration:
        IntegrationHttpMethod: 'GET'
        RequestParameters:
          integration.request.path.requested_address:
            'method.request.path.requested_address'
        Type: 'HTTP_PROXY'
        Uri: !Sub 'http://${LoadBalancer.DNSName}/{requested_address}'
      RequestParameters:
        method.request.path.requested_address: true
      ResourceId: !Ref 'RestApiRequestedAddress'
      RestApiId: !Ref 'RestApi'
    Type: 'AWS::ApiGateway::Method'
  # POST method for the REST API, forwarding requests to the load balancer.
  # Requires IAM authentication.
  RestApiPost:
    DependsOn:
    - 'LoadBalancerListener'
    Properties:
      ApiKeyRequired: false
      AuthorizationType: 'AWS_IAM'
      HttpMethod: 'POST'
      Integration:
        IntegrationHttpMethod: 'POST'
        RequestParameters:
          integration.request.path.requested_address:
            'method.request.path.requested_address'
        Type: 'HTTP_PROXY'
        Uri: !Sub 'http://${LoadBalancer.DNSName}/{requested_address}'
      RequestParameters:
        method.request.path.requested_address: true
      ResourceId: !Ref 'RestApiRequestedAddress'
      RestApiId: !Ref 'RestApi'
    Type: 'AWS::ApiGateway::Method'
  # Path capture for the requested address in the REST API.
  RestApiRequestedAddress:
    Properties:
      ParentId: !GetAtt 'RestApi.RootResourceId'
      PathPart: '{requested_address}'
      RestApiId: !Ref 'RestApi'
    Type: 'AWS::ApiGateway::Resource'
...
